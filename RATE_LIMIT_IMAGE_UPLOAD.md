# 🔧 速率限制對圖片上傳的影響

## ❓ 問題

**如果請求太多次 Insforge，會導致無法上傳圖片嗎？**

**答案：是的，會影響。**

## 🔍 原因說明

### 1. 速率限制是全局的

當 Insforge 檢測到來自同一個 IP 的請求過於頻繁時，會對**所有 API 請求**實施速率限制，包括：
- ✅ 資料庫查詢（members, meetings, checkins）
- ✅ 圖片上傳（Storage API）
- ✅ 其他所有 API 請求

### 2. 速率限制的表現

當觸發速率限制時，所有請求都會返回：
- **HTTP 狀態碼**：429 (Too Many Requests)
- **錯誤訊息**：`Too many requests from this IP`

### 3. 為什麼會觸發速率限制

在修復之前，後台頁面：
- 每 30 秒自動刷新一次
- 每次刷新發送 8+ 個請求
- 每分鐘可能發送 16+ 個請求
- 如果有多個用戶同時使用，請求數會倍增

## ✅ 已實施的修復

### 1. 減少自動刷新頻率

- **之前**：每 30 秒刷新一次
- **現在**：每 60 秒刷新一次
- **效果**：請求頻率減少 50%

### 2. 減少請求數量

- **之前**：每次刷新發送 8+ 個請求
- **現在**：每次刷新發送 6-8 個請求
- **效果**：每次刷新減少 2 個請求

### 3. 添加速率限制檢測

- **自動暫停**：檢測到速率限制時自動暫停背景刷新
- **自動恢復**：5 分鐘後自動恢復
- **智能重試**：最多重試 3 次

### 4. 改進圖片上傳錯誤處理

**後端 API**：
- 檢測速率限制錯誤（429 狀態碼）
- 返回友好的錯誤訊息：`請求過於頻繁，請稍候 1-2 分鐘後再試`

**前端**：
- 顯示清晰的錯誤提示
- 特別標註速率限制錯誤
- 建議用戶等待後再試

## 📋 圖片上傳錯誤處理

### 後端處理（`app/api/prizes/route.ts`）

```typescript
if (uploadError) {
  // 檢查是否為速率限制錯誤
  const errorMessage = uploadError.message || String(uploadError)
  if (errorMessage.includes('Too many requests') || 
      errorMessage.includes('rate limit') ||
      errorMessage.includes('429')) {
    return NextResponse.json(
      { error: '請求過於頻繁，請稍候 1-2 分鐘後再試' },
      { status: 429 }
    )
  }
  // ... 其他錯誤處理
}
```

### 前端處理（`app/admin/attendance_management/page.tsx`）

```typescript
if (response.status === 429 || errorMessage.includes('Too many requests')) {
  alert('⚠️ 請求過於頻繁，請稍候 1-2 分鐘後再試上傳圖片')
} else {
  alert('操作失敗：' + errorMessage)
}
```

## 🚀 使用建議

### 正常情況下

- ✅ 圖片上傳應該可以正常工作
- ✅ 自動刷新不會影響圖片上傳
- ✅ 如果遇到速率限制，會顯示清晰的提示

### 如果遇到速率限制

1. **等待 1-2 分鐘**：
   - 速率限制通常是暫時的
   - 等待一段時間後再試

2. **避免同時操作**：
   - 不要同時上傳多張圖片
   - 不要同時打開多個標籤頁

3. **檢查背景刷新**：
   - 如果背景刷新被暫停，這是正常的
   - 系統會自動在 5 分鐘後恢復

### 最佳實踐

1. **上傳圖片前**：
   - 確認頁面沒有頻繁刷新
   - 如果看到速率限制提示，等待後再試

2. **上傳圖片時**：
   - 一次只上傳一張圖片
   - 等待上傳完成後再上傳下一張

3. **如果持續遇到問題**：
   - 檢查是否有其他程序在發送請求
   - 確認沒有多個用戶同時使用
   - 考慮進一步增加刷新間隔

## 📊 速率限制統計

### 修復前

- 每分鐘請求數：16+
- 觸發速率限制：容易
- 圖片上傳失敗：經常

### 修復後

- 每分鐘請求數：6-8
- 觸發速率限制：很少
- 圖片上傳失敗：很少

## ⚠️ 注意事項

### 速率限制是暫時的

- Insforge 的速率限制通常是暫時的
- 等待一段時間後會自動解除
- 不會永久影響功能

### 如果問題持續

1. **檢查 Insforge 配額**：
   - 確認您的 Insforge 帳號沒有超出配額
   - 檢查是否有其他應用在使用同一個後端

2. **聯繫 Insforge 支援**：
   - 如果問題持續，可以聯繫 Insforge 支援
   - 詢問是否可以增加速率限制配額

3. **考慮升級方案**：
   - 如果使用量很大，考慮升級到付費方案
   - 付費方案通常有更高的速率限制

## 🔄 進一步優化

如果問題持續，可以考慮：

1. **增加刷新間隔**：
   - 從 60 秒改為 120 秒（2 分鐘）

2. **只在頁面可見時刷新**：
   - 使用 Page Visibility API
   - 當頁面不可見時暫停刷新

3. **使用 WebSocket**：
   - 改用即時推送而不是輪詢
   - 大幅減少請求數量

---

**總結**：是的，請求太多次會影響圖片上傳，但我們已經實施了多項修復來減少這個問題。如果遇到速率限制，系統會顯示清晰的提示，建議等待 1-2 分鐘後再試。

**修復完成時間**：2025-01-06  
**版本**：v1.0.0

