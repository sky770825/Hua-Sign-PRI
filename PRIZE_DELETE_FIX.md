# 🔧 獎品刪除問題修復

## 🐛 問題描述

有一個「藥包」獎品無法刪除。

## 🔍 問題原因

### 可能的原因

1. **外鍵約束錯誤** ⚠️ **最可能**
   - `checkin_lottery_winners` 表有 `prize_id` 欄位引用 `checkin_prizes` 表
   - 如果此獎品有中獎記錄，資料庫會阻止刪除（外鍵約束）
   - 錯誤訊息通常包含：`foreign key constraint` 或 `23503`

2. **資料庫權限問題**
   - 用戶沒有刪除權限
   - 表有特殊的刪除限制

3. **前端錯誤處理不完整**
   - 前端沒有正確顯示錯誤訊息
   - 用戶看不到具體的錯誤原因

## ✅ 修復方案

### 1. 檢查並自動刪除中獎記錄

**改進內容**：
- 刪除獎品前，先檢查是否有中獎記錄
- 如果有中獎記錄，自動刪除相關記錄
- 然後再刪除獎品

**代碼實現**：
```typescript
// 檢查是否有中獎記錄引用此獎品
const { data: winners } = await insforge.database
  .from(TABLES.LOTTERY_WINNERS)
  .select('id')
  .eq('prize_id', id)
  .limit(1)

if (winners && winners.length > 0) {
  // 先刪除相關的中獎記錄
  await insforge.database
    .from(TABLES.LOTTERY_WINNERS)
    .delete()
    .eq('prize_id', id)
}
```

### 2. 改進錯誤處理

**改進內容**：
- 檢測外鍵約束錯誤（錯誤碼 `23503`）
- 返回清晰的錯誤訊息（中文）
- 提供解決建議

**錯誤訊息**：
- 之前：`刪除獎品失敗：資料庫錯誤`
- 現在：`無法刪除獎品：此獎品有中獎記錄，請先刪除相關中獎記錄。系統已嘗試自動刪除，但可能仍有其他引用。`

### 3. 詳細的日誌記錄

**改進內容**：
- 記錄獎品信息（ID、名稱）
- 記錄中獎記錄數量
- 記錄刪除過程的每個步驟
- 記錄詳細的錯誤信息

## 🔍 如何診斷問題

### 步驟 1：查看 Vercel 日誌

1. 訪問 Vercel Dashboard：
   ```
   https://vercel.com/linebot/hua-sign-pri-j5js
   ```

2. 點擊 "Functions" 標籤

3. 找到 `/api/prizes/[id]` 函數

4. 嘗試刪除「藥包」獎品

5. 查看日誌，尋找：
   - `刪除獎品:` - 確認刪除開始
   - `獎品有中獎記錄` - 如果有中獎記錄
   - `Error deleting prize:` - 查看詳細錯誤

### 步驟 2：檢查中獎記錄

如果日誌顯示「獎品有中獎記錄」，可以：

1. **手動刪除中獎記錄**：
   - 訪問後台管理頁面
   - 找到相關的中獎記錄
   - 手動刪除

2. **或使用 API 刪除**：
   - 查詢所有引用此獎品的中獎記錄
   - 刪除這些記錄
   - 然後再刪除獎品

### 步驟 3：檢查資料庫

如果問題持續，可以：

1. **檢查外鍵約束**：
   - 確認 `checkin_lottery_winners.prize_id` 是否引用 `checkin_prizes.id`
   - 確認是否有級聯刪除設置

2. **檢查中獎記錄**：
   - 查詢所有 `prize_id` 等於此獎品 ID 的記錄
   - 確認是否有記錄

## 📋 修復後的流程

### 刪除獎品的完整流程

1. **檢查獎品是否存在**
   - 如果不存在，返回 404 錯誤

2. **檢查是否有中獎記錄**
   - 如果有，自動刪除相關記錄
   - 記錄刪除的記錄數量

3. **刪除圖片文件**
   - 如果獎品有圖片，刪除圖片文件
   - 即使圖片刪除失敗，也繼續刪除獎品

4. **刪除獎品**
   - 從資料庫刪除獎品記錄
   - 如果失敗，返回詳細的錯誤訊息

5. **返回結果**
   - 成功：返回 `{ success: true, data: deletedPrize }`
   - 失敗：返回詳細的錯誤訊息

## 🎯 測試步驟

### 測試 1：刪除沒有中獎記錄的獎品

1. 創建一個新獎品
2. 不進行任何抽獎
3. 嘗試刪除此獎品
4. 應該成功刪除

### 測試 2：刪除有中獎記錄的獎品

1. 創建一個新獎品
2. 進行抽獎，讓此獎品中獎
3. 嘗試刪除此獎品
4. 系統應該自動刪除中獎記錄，然後刪除獎品

### 測試 3：刪除「藥包」獎品

1. 嘗試刪除「藥包」獎品
2. 查看 Vercel 日誌
3. 如果失敗，查看具體的錯誤訊息
4. 根據錯誤訊息採取相應措施

## 🔧 如果仍然無法刪除

### 方法 1：手動刪除中獎記錄

1. **查詢中獎記錄**：
   - 訪問後台管理頁面
   - 查看抽獎記錄
   - 找到所有「藥包」的中獎記錄

2. **刪除中獎記錄**：
   - 手動刪除這些記錄
   - 或通過 API 刪除

3. **再次嘗試刪除獎品**

### 方法 2：直接操作資料庫

如果通過 API 無法刪除，可以：

1. **登入 Insforge Dashboard**
2. **進入資料庫管理**
3. **手動刪除**：
   - 先刪除 `checkin_lottery_winners` 表中 `prize_id` 等於此獎品 ID 的記錄
   - 然後刪除 `checkin_prizes` 表中的獎品記錄

### 方法 3：查看詳細錯誤

1. **查看 Vercel 日誌**
2. **複製完整的錯誤訊息**
3. **根據錯誤訊息採取相應措施**

## 📝 錯誤訊息說明

### 錯誤 1：外鍵約束錯誤

**錯誤訊息**：
```
無法刪除獎品：此獎品有中獎記錄，請先刪除相關中獎記錄。
```

**解決方法**：
- 系統會自動嘗試刪除中獎記錄
- 如果自動刪除失敗，請手動刪除

### 錯誤 2：獎品不存在

**錯誤訊息**：
```
獎品不存在
```

**解決方法**：
- 確認獎品 ID 是否正確
- 確認獎品是否已被刪除

### 錯誤 3：資料庫錯誤

**錯誤訊息**：
```
刪除獎品失敗：資料庫錯誤 (錯誤碼: 23503)
```

**解決方法**：
- 錯誤碼 `23503` 表示外鍵約束錯誤
- 需要先刪除相關的中獎記錄

## 🎯 總結

### ✅ 已修復

- 添加中獎記錄檢查
- 自動刪除相關中獎記錄
- 改進錯誤處理和訊息
- 添加詳細的日誌記錄

### ⚠️ 如果仍然無法刪除

請提供：
1. Vercel 日誌中的完整錯誤訊息
2. 獎品的 ID 和名稱
3. 是否有中獎記錄

這樣我可以進一步診斷問題。

---

**修復已完成！** 🎉

現在刪除獎品時，系統會：
- ✅ 自動檢查中獎記錄
- ✅ 自動刪除相關記錄
- ✅ 提供清晰的錯誤訊息
- ✅ 記錄詳細的操作日誌

