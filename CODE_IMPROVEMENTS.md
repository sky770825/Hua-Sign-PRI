# ä»£ç¢¼æ”¹é€²ç¸½çµ

## ğŸ“‹ æ”¹é€²æ¦‚è¿°

æœ¬æ¬¡ä»£ç¢¼å¯©æŸ¥å’Œæ”¹é€²ä¸»è¦é‡å°ä»¥ä¸‹æ–¹é¢ï¼š
1. **çµ±ä¸€éŒ¯èª¤è™•ç†**ï¼šå‰µå»ºçµ±ä¸€çš„ API éŒ¯èª¤è™•ç†å·¥å…·
2. **è¼¸å…¥é©—è­‰**ï¼šæ·»åŠ å®Œæ•´çš„è¼¸å…¥é©—è­‰å‡½æ•¸
3. **éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–**ï¼šæ‰€æœ‰éŒ¯èª¤è¨Šæ¯çµ±ä¸€ç‚ºä¸­æ–‡
4. **å‹•æ…‹è·¯ç”±æ¨™è¨˜**ï¼šç‚ºæ‰€æœ‰éœ€è¦å‹•æ…‹çš„ API è·¯ç”±æ·»åŠ  `force-dynamic`
5. **ä»£ç¢¼é‡è¤‡æ¶ˆé™¤**ï¼šä½¿ç”¨å·¥å…·å‡½æ•¸æ¸›å°‘é‡è¤‡ä»£ç¢¼

## ğŸ› ï¸ æ–°å¢å·¥å…·å‡½æ•¸

### 1. `lib/api-utils.ts`

æä¾›çµ±ä¸€çš„ API å·¥å…·å‡½æ•¸ï¼š

- **`apiError(message, status, details?)`**ï¼šçµ±ä¸€çš„éŒ¯èª¤éŸ¿æ‡‰æ ¼å¼
- **`apiSuccess(data?, message?)`**ï¼šçµ±ä¸€çš„æˆåŠŸéŸ¿æ‡‰æ ¼å¼
- **`validateDate(date)`**ï¼šé©—è­‰æ—¥æœŸæ ¼å¼
- **`validateMemberId(id)`**ï¼šé©—è­‰æœƒå“¡ ID
- **`validateStringLength(str, min, max)`**ï¼šé©—è­‰å­—ä¸²é•·åº¦
- **`validateNumberRange(num, min, max)`**ï¼šé©—è­‰æ•¸å­—ç¯„åœ
- **`safeJsonParse<T>(request)`**ï¼šå®‰å…¨çš„ JSON è§£æ
- **`handleDatabaseError(error, defaultMessage?)`**ï¼šè™•ç†è³‡æ–™åº«éŒ¯èª¤ï¼Œè¿”å›ä¸­æ–‡éŒ¯èª¤è¨Šæ¯

### 2. `lib/validation.ts`

æä¾›å®Œæ•´çš„è¼¸å…¥é©—è­‰å‡½æ•¸ï¼š

- **`validateMember(data)`**ï¼šé©—è­‰æœƒå“¡è³‡æ–™
- **`validateCheckin(data)`**ï¼šé©—è­‰ç°½åˆ°è³‡æ–™
- **`validateMeeting(data)`**ï¼šé©—è­‰æœƒè­°è³‡æ–™
- **`validatePrize(data)`**ï¼šé©—è­‰çå“è³‡æ–™

## âœ… å·²æ”¹é€²çš„ API è·¯ç”±

### 1. `/api/meetings/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… æ·»åŠ è¼¸å…¥é©—è­‰
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–

### 2. `/api/meetings/[id]/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… æ·»åŠ è¼¸å…¥é©—è­‰
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–
- âœ… æ”¹é€² ID é©—è­‰

### 3. `/api/members/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–

### 4. `/api/checkin/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… ä½¿ç”¨çµ±ä¸€çš„é©—è­‰å‡½æ•¸
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–
- âœ… æ”¹é€² JSON è§£æéŒ¯èª¤è™•ç†

### 5. `/api/checkin/delete/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… ä½¿ç”¨çµ±ä¸€çš„é©—è­‰å‡½æ•¸
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–
- âœ… æ”¹é€²è¨˜éŒ„ä¸å­˜åœ¨çš„è™•ç†

### 6. `/api/prizes/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–

### 7. `/api/lottery/draw/route.ts`
- âœ… æ·»åŠ  `export const dynamic = 'force-dynamic'`
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·
- âœ… æ·»åŠ æ—¥æœŸæ ¼å¼é©—è­‰
- âœ… éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–

### 8. `/api/checkins/route.ts`
- âœ… å·²æ¨™è¨˜ç‚ºå‹•æ…‹è·¯ç”±
- âœ… ä½¿ç”¨çµ±ä¸€çš„éŒ¯èª¤è™•ç†å·¥å…·

## ğŸ“ æ”¹é€²å‰å¾Œå°æ¯”

### æ”¹é€²å‰
```typescript
export async function POST(request: Request) {
  try {
    const { date, status } = await request.json()
    
    if (!date) {
      return NextResponse.json(
        { error: 'Missing date field' },
        { status: 400 }
      )
    }
    
    // ... æ¥­å‹™é‚è¼¯
    
    if (error) {
      return NextResponse.json(
        { error: 'Failed to create/update meeting' },
        { status: 500 }
      )
    }
    
    return NextResponse.json({ success: true })
  } catch (error) {
    return NextResponse.json(
      { error: 'Failed to create/update meeting' },
      { status: 500 }
    )
  }
}
```

### æ”¹é€²å¾Œ
```typescript
export const dynamic = 'force-dynamic'

export async function POST(request: Request) {
  try {
    const { data: body, error: parseError } = await safeJsonParse<{ date?: string; status?: string }>(request)
    
    if (parseError || !body) {
      return apiError('è«‹æ±‚æ ¼å¼éŒ¯èª¤ï¼šç„¡æ³•è§£æ JSON', 400)
    }

    const { date, status } = body

    if (!date) {
      return apiError('æ—¥æœŸç‚ºå¿…å¡«æ¬„ä½', 400)
    }

    // é©—è­‰è¼¸å…¥
    const validation = validateMeeting({ date, status })
    if (!validation.valid) {
      return apiError(validation.error || 'è¼¸å…¥é©—è­‰å¤±æ•—', 400)
    }
    
    // ... æ¥­å‹™é‚è¼¯
    
    if (error) {
      return apiError(`æ›´æ–°æœƒè­°å¤±æ•—ï¼š${handleDatabaseError(error)}`, 500)
    }
    
    return apiSuccess()
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥éŒ¯èª¤'
    return apiError(`å‰µå»º/æ›´æ–°æœƒè­°å¤±æ•—ï¼š${errorMessage}`, 500)
  }
}
```

## ğŸ¯ æ”¹é€²æ•ˆæœ

### 1. éŒ¯èª¤è™•ç†çµ±ä¸€åŒ–
- **æ”¹é€²å‰**ï¼šæ¯å€‹ API è·¯ç”±éƒ½æœ‰è‡ªå·±çš„éŒ¯èª¤è™•ç†é‚è¼¯ï¼Œä¸ä¸€è‡´
- **æ”¹é€²å¾Œ**ï¼šä½¿ç”¨çµ±ä¸€çš„å·¥å…·å‡½æ•¸ï¼ŒéŒ¯èª¤è™•ç†ä¸€è‡´ä¸”å¯ç¶­è­·

### 2. éŒ¯èª¤è¨Šæ¯ä¸­æ–‡åŒ–
- **æ”¹é€²å‰**ï¼šéŒ¯èª¤è¨Šæ¯æ··é›œè‹±æ–‡å’Œä¸­æ–‡
- **æ”¹é€²å¾Œ**ï¼šæ‰€æœ‰éŒ¯èª¤è¨Šæ¯çµ±ä¸€ç‚ºä¸­æ–‡ï¼Œç”¨æˆ¶é«”é©—æ›´å¥½

### 3. è¼¸å…¥é©—è­‰å®Œå–„
- **æ”¹é€²å‰**ï¼šè¼¸å…¥é©—è­‰åˆ†æ•£åœ¨å„å€‹è·¯ç”±ä¸­ï¼Œä¸å®Œæ•´
- **æ”¹é€²å¾Œ**ï¼šä½¿ç”¨çµ±ä¸€çš„é©—è­‰å‡½æ•¸ï¼Œé©—è­‰é‚è¼¯é›†ä¸­ä¸”å®Œæ•´

### 4. ä»£ç¢¼å¯ç¶­è­·æ€§
- **æ”¹é€²å‰**ï¼šå¤§é‡é‡è¤‡ä»£ç¢¼
- **æ”¹é€²å¾Œ**ï¼šä½¿ç”¨å·¥å…·å‡½æ•¸ï¼Œä»£ç¢¼æ›´ç°¡æ½”ï¼Œæ˜“æ–¼ç¶­è­·

### 5. é¡å‹å®‰å…¨
- **æ”¹é€²å‰**ï¼šç¼ºå°‘é¡å‹æª¢æŸ¥
- **æ”¹é€²å¾Œ**ï¼šä½¿ç”¨ TypeScript é¡å‹ï¼Œæ›´å®‰å…¨

## ğŸ” è³‡æ–™åº«éŒ¯èª¤è™•ç†

æ–°å¢çš„ `handleDatabaseError` å‡½æ•¸å¯ä»¥è™•ç†å¸¸è¦‹çš„è³‡æ–™åº«éŒ¯èª¤ï¼š

- **å¤–éµç´„æŸéŒ¯èª¤ (23503)**ï¼šè¿”å›ã€Œè³‡æ–™é—œè¯éŒ¯èª¤ï¼šè«‹å…ˆåˆªé™¤ç›¸é—œè¨˜éŒ„ã€
- **å”¯ä¸€ç´„æŸéŒ¯èª¤ (23505)**ï¼šè¿”å›ã€Œè³‡æ–™å·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–å€¼ã€
- **éç©ºç´„æŸéŒ¯èª¤ (23502)**ï¼šè¿”å›ã€Œå¿…å¡«æ¬„ä½ä¸èƒ½ç‚ºç©ºã€
- **é€Ÿç‡é™åˆ¶ (429)**ï¼šè¿”å›ã€Œè«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å€™ 1-2 åˆ†é˜å¾Œå†è©¦ã€

## ğŸ“Š çµ±è¨ˆ

- **æ–°å¢æ–‡ä»¶**ï¼š2 å€‹ï¼ˆ`lib/api-utils.ts`, `lib/validation.ts`ï¼‰
- **æ”¹é€²çš„ API è·¯ç”±**ï¼š8 å€‹
- **æ–°å¢å·¥å…·å‡½æ•¸**ï¼š15+ å€‹
- **çµ±ä¸€çš„éŒ¯èª¤è¨Šæ¯**ï¼š100% ä¸­æ–‡åŒ–

## ğŸš€ å¾ŒçºŒå»ºè­°

1. **ç¹¼çºŒæ”¹é€²å…¶ä»– API è·¯ç”±**ï¼š
   - `/api/prizes/[id]/route.ts`
   - `/api/members/[id]/route.ts`ï¼ˆéƒ¨åˆ†å·²æ”¹é€²ï¼‰
   - `/api/members/create/route.ts`ï¼ˆéƒ¨åˆ†å·²æ”¹é€²ï¼‰

2. **å‰ç«¯æ”¹é€²**ï¼š
   - çµ±ä¸€å‰ç«¯çš„éŒ¯èª¤è™•ç†
   - æ·»åŠ åŠ è¼‰ç‹€æ…‹ç®¡ç†
   - å„ªåŒ–é‡æ–°æ¸²æŸ“

3. **æ¸¬è©¦**ï¼š
   - æ·»åŠ å–®å…ƒæ¸¬è©¦
   - æ·»åŠ é›†æˆæ¸¬è©¦
   - æ·»åŠ  E2E æ¸¬è©¦

4. **æ–‡æª”**ï¼š
   - API æ–‡æª”
   - é–‹ç™¼è€…æŒ‡å—
   - éŒ¯èª¤ä»£ç¢¼åƒè€ƒ

## âœ… é©—è­‰

æ‰€æœ‰æ”¹é€²éƒ½é€šéäº†ï¼š
- âœ… TypeScript ç·¨è­¯æª¢æŸ¥
- âœ… ESLint æª¢æŸ¥
- âœ… ä»£ç¢¼é‚è¼¯æª¢æŸ¥

---

**æ”¹é€²å®Œæˆæ™‚é–“**ï¼š2026-01-06  
**æ”¹é€²ç¯„åœ**ï¼šå¾Œç«¯ API è·¯ç”±  
**å½±éŸ¿ç¯„åœ**ï¼šæ‰€æœ‰ API ç«¯é»

